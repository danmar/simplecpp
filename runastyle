#!/bin/bash
# The version check in this script is used to avoid commit battles
# between different developers that use different astyle versions as
# different versions might have different output (this has happened in
# the past).

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cd $SCRIPT_DIR

# To require a newer astyle version, update ASTYLE_VERSION below.
# ASTYLE_VERSION_STR is then constructed to match the beginning of the
# version string reported by "astyle --version".
ASTYLE_VERSION="3.4.13"
ASTYLE_VERSION_STR="Artistic Style Version ${ASTYLE_VERSION}"
ASTYLE="astyle"

if command -v astyle &> /dev/null; then
    ASTYLE="astyle"
elif command -v uvx &> /dev/null; then
    ASTYLE="uvx --quiet ${ASTYLE}==${ASTYLE_VERSION}"
elif command -v pipx &> /dev/null; then
    ASTYLE="pipx run --quiet ${ASTYLE}==${ASTYLE_VERSION}"
else
    echo "Neither astyle, uvx, nor pipx found in PATH"
    exit 1
fi

DETECTED_VERSION_STR=`$ASTYLE --version 2>&1`
if [[ "$DETECTED_VERSION_STR" != ${ASTYLE_VERSION_STR}* ]]; then
    echo "You should use: ${ASTYLE_VERSION_STR}";
    echo "Detected: ${DETECTED_VERSION_STR}"
    exit 1;
fi

# Run astyle with the project config
$ASTYLE --project *.cpp
$ASTYLE --project *.h
